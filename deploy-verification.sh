#!/bin/bash

echo "ğŸ” Verifying deployment readiness for Dr. Ganesh Eye Appointment Portal..."
echo "=================================================================="

# Check if we're in the right directory
if [ ! -f "package.json" ] || [ ! -f "vercel.json" ]; then
    echo "âŒ Error: Run this script from the frontend directory"
    exit 1
fi

echo "ğŸ“‹ Pre-deployment checklist:"
echo ""

# Check Node.js version
NODE_VERSION=$(node --version)
echo "âœ“ Node.js version: $NODE_VERSION"

# Check if .nvmrc exists
if [ -f ".nvmrc" ]; then
    NVMRC_VERSION=$(cat .nvmrc)
    echo "âœ“ .nvmrc version: $NVMRC_VERSION"
else
    echo "âš ï¸  .nvmrc file missing"
fi

# Check if vercel.json exists and is valid
if [ -f "vercel.json" ]; then
    if npx json-lint vercel.json > /dev/null 2>&1; then
        echo "âœ“ vercel.json is valid JSON"
    else
        echo "âŒ vercel.json has invalid JSON"
        exit 1
    fi
else
    echo "âŒ vercel.json missing"
    exit 1
fi

# Clean build test
echo ""
echo "ğŸ§¹ Cleaning previous build..."
rm -rf dist/
rm -rf node_modules/.vite/

echo ""
echo "ğŸ”¨ Testing build process..."
if npm run build; then
    echo "âœ… Build successful!"
else
    echo "âŒ Build failed!"
    exit 1
fi

# Check if dist directory exists and has content
if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
    echo "âœ… dist directory created with content"
    echo "ğŸ“ Files in dist:"
    ls -la dist/
else
    echo "âŒ dist directory missing or empty"
    exit 1
fi

# Check if index.html exists
if [ -f "dist/index.html" ]; then
    echo "âœ… index.html exists in dist/"
else
    echo "âŒ index.html missing from dist/"
    exit 1
fi

# Check environment variables
echo ""
echo "ğŸŒ Environment configuration:"
if [ -f ".env.production" ]; then
    echo "âœ“ .env.production exists"
    echo "ğŸ“„ Production environment variables:"
    cat .env.production | grep -v "^#" | head -5
else
    echo "âš ï¸  .env.production file missing (you'll need to set env vars in Vercel)"
fi

echo ""
echo "ğŸš€ Deployment readiness summary:"
echo "================================"
echo "âœ… Node.js version compatible"
echo "âœ… Build process working"
echo "âœ… Output directory (dist) created"
echo "âœ… Vercel configuration valid"
echo ""
echo "ğŸ‰ Ready for deployment!"
echo ""
echo "To deploy, run one of these commands:"
echo "1. ./deploy-portal.sh (automated)"
echo "2. vercel --prod (manual)"
echo "3. git push origin main (if auto-deploy is set up)"
echo ""
